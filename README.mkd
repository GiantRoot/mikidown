The code is a bit ugly.
